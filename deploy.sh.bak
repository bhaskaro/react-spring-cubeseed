#!/usr/bin/env bash
set -euo pipefail

COMPOSE="docker compose"   # change to 'docker-compose' if you use the old plugin
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT"

echo "==> Project: $ROOT"

# ---- Options ---------------------------------------------------------------
CLEAN_IMAGES=0
if [[ "${1:-}" == "--prune" ]]; then
  CLEAN_IMAGES=1
fi

# ---- Sanity checks ---------------------------------------------------------
if ! docker --version >/dev/null 2>&1; then
  echo "Docker is required." >&2; exit 1
fi
if ! $COMPOSE version >/dev/null 2>&1; then
  echo "'docker compose' is required." >&2; exit 1
fi

# Ensure JWT secret is present (single line) for the API
if [[ ! -f .env ]]; then
  echo "Missing .env (JWT_SECRET is required for API)."
  echo "Create one with a single line, e.g.:"
  echo '  JWT_SECRET=$(openssl rand -base64 64 | tr -d "\r\n")' 
  exit 1
fi
if ! grep -qE '^JWT_SECRET=.{10,}$' .env; then
  echo "JWT_SECRET missing or empty in .env" >&2; exit 1
fi
if grep -q $'\r' .env || grep -q $'\n' <(cut -d= -f2- .env | head -n1); then
  echo "JWT_SECRET must be a single line (no CR/LF)." >&2; exit 1
fi

# ---- Optional cleanup ------------------------------------------------------
echo "==> Stopping existing containers (keeping DB volume)..."
$COMPOSE down --remove-orphans || true

if [[ $CLEAN_IMAGES -eq 1 ]]; then
  echo "==> Pruning dangling images/build cache (optional)..."
  docker image prune -f || true
  docker builder prune -f || true
fi

# ---- Rebuild images --------------------------------------------------------
# We rebuild only api & web. DB is off-the-shelf postgres image.
echo "==> Building images (no cache) for api & web..."
$COMPOSE build --no-cache api web

# ---- Start services --------------------------------------------------------
echo "==> Starting DB, then API & WEB..."
$COMPOSE up -d db
# wait a bit for db healthcheck
echo "==> Waiting for DB to be healthy..."
for i in {1..30}; do
  if $COMPOSE ps | grep -q "db.*(healthy)"; then
    echo "DB is healthy."; break
  fi
  sleep 1
  if [[ $i -eq 30 ]]; then echo "DB not healthy in time."; exit 1; fi
done

$COMPOSE up -d api web

# ---- Health checks ---------------------------------------------------------
echo "==> Waiting for API to be ready on :8080 ..."
for i in {1..30}; do
  if curl -fsS http://localhost:8080/actuator/health >/dev/null; then
    echo "API is up."; break
  fi
  sleep 1
  if [[ $i -eq 30 ]]; then
    echo "API failed to start. Recent logs:" >&2
    $COMPOSE logs --tail=120 api >&2 || true
    exit 1
  fi
done

echo "==> Quick checks:"
echo "• Host → API /api/hello:"
curl -fsS http://localhost:8080/api/hello || true
echo -e "\n"

echo "• Web (nginx) static bundle:"
curl -fsSI http://localhost/assets/ | head -n 1 || true

echo "• Web → API (inside network):"
$COMPOSE exec -T web sh -lc 'wget -qO- http://api:8080/api/hello || echo FAIL' || true
echo

echo "==> DONE."
echo "Open the app at:  http://<server-ip>/"
echo "API direct:       http://<server-ip>:8080/api/hello"
echo
echo "Tips:"
echo "  ./deploy.sh           # rebuild api+web, restart stack"
echo "  ./deploy.sh --prune   # also prune dangling images/cache"

